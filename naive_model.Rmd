---
title: "models"
author: "Vojtěch Máčala, Anna Hýsková, Karolína Rusnačková"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: true
---

```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(tibble)
library(tidyr)
library(caret)
library(stringr)
library(reshape2)
library(Matrix)
library(recommenderlab)
library(data.table)
library(DT)
library(scales)
library(ggthemes)
library(cowplot)
```

## Load Data
```{r}
ratings <- read.csv(file = "data/reviews_tab_filtered.csv", sep = ",", dec = ",") |> mutate(
  user_id = as.numeric(factor(user_id))
)

books <- read.csv(file = "data/dataset_goodreads_filtered.csv", sep = ",", dec = ",") |>
  dplyr::select(title,book_id,genre)

books_ratings <- left_join(ratings, books, by = "book_id") |> select(book_id, user_id, rating)
str(books_ratings)
```
We will only retain users with 10 and more ratings
```{r}
book_ratings_count <- table(books_ratings$book_id)
user_ratings_count <- table(books_ratings$user_id)

books_with_at_least_10_ratings <- names(book_ratings_count[book_ratings_count >= 10])
users_with_at_least_10_ratings <- names(user_ratings_count[user_ratings_count >= 10])

books_ratings <- books_ratings[books_ratings$user_id %in% users_with_at_least_10_ratings, ]
books_ratings <- books_ratings[books_ratings$book_id %in% books_with_at_least_10_ratings, ]
books_ratings <- books_ratings[complete.cases(books_ratings$user_id, books_ratings$book_id), ]
```

```{r}
num_user_id <- books_ratings$user_id %>% unique %>% length
num_book <- books_ratings$book_id %>% unique %>% length

sprintf("Number of ratings: %d", dim(books_ratings)[1])
sprintf("Number of users: %d", num_user_id)
sprintf("Number of books: %d", num_book)
```
Not enough memory :( We will work only with a small subset
```{r}
n <- 1000

first_n_users <- books_ratings$user_id %>% unique %>% head(n)
books_ratings <- books_ratings[books_ratings$user_id %in% first_n_users, ]

str(books_ratings)
nrow(books_ratings)
```
User-Book Format
```{r}
ratings_filtered <- books_ratings |> reshape2::dcast(user_id ~ book_id,value.var = "rating")
rownames(ratings_filtered) <- ratings_filtered$user_id
ratings_filtered <- ratings_filtered[, -1]
```
Transformation into a RealRatingMatrix (contains NAs)
```{r}
ratings_mat <- as.matrix(ratings_filtered)
ratings_mat <- as(ratings_mat, 'realRatingMatrix')

dim(ratings_mat)
```
Train Test Split
```{r}
set.seed(123)

split_data <- evaluationScheme(ratings_mat, method="split", train=0.8, given=3, goodRating=3)
```

! [Recommenders](recommenders.png)
```{r}
recommenderRegistry$get_entries(dataType = "realRatingMatrix") %>% 
  names()
```
## SVDF
```{r}
book_reco_SVDF <- Recommender(getData(split_data, "train"), "SVDF", parameter = list(normalize = "Z-score", verbose = TRUE))
predictions_SVDF <- predict(book_reco_SVDF, getData(split_data, "known"), type="ratings")  

acc_list <- calcPredictionAccuracy(predictions_SVDF, getData(split_data, "unknown"))
total_list <- c(algorithm = "SVDF", acc_list)
total_list <- total_list[sapply(total_list, function(x) !is.null(x))]

table_SVDF <- data.frame(as.list(total_list))
```
Imputation of the missing values for other models (NAs are replaced by column medians)
```{r}
impute_median <- function(x){
   x[is.na(x)] = median(x, na.rm=TRUE) 
   return(x)
}
ratings_filtered_impute <- apply(ratings_filtered, 2, impute_median) |> as.data.frame()
```
```{r}
ratings_mat <- as.matrix(ratings_filtered_impute)
ratings_mat <- as(ratings_mat, 'realRatingMatrix')
```
Train Test Split (the same)
```{r}
set.seed(123)

split_data <- evaluationScheme(ratings_mat, method="split", train=0.8, given=3, goodRating=3)
```
## UBCF 
```{r}
book_reco_UBCF <- Recommender(getData(split_data, "train"), "UBCF", parameter = list(normalize = NULL, method="Cosine"))
predictions_ubcf <- predict(book_reco_UBCF, getData(split_data, "known"), type="ratings") 

acc_list <- calcPredictionAccuracy(predictions_ubcf, getData(split_data, "unknown"))
total_list <- c(algorithm = "UBCF", acc_list)
total_list <- total_list[sapply(total_list, function(x) !is.null(x))]

table_UBCF <- data.frame(as.list(total_list))
```
## UBCF Normalized
```{r}
book_reco_UBCF_centered <- Recommender(getData(split_data, "train"), "UBCF", parameter = list(normalize = "center", method="Cosine"))
predictions_UBCF_centered <- predict(book_reco_UBCF_centered, getData(split_data, "known"), type="ratings")  

acc_list <- calcPredictionAccuracy(predictions_UBCF_centered, getData(split_data, "unknown"))
total_list <- c(algorithm = "UBCF Normalized", acc_list)
total_list <- total_list[sapply(total_list, function(x) !is.null(x))]

table_UBCF_centered <- data.frame(as.list(total_list))
```
```{r}
rbind(table_UBCF_centered, table_UBCF, table_SVDF)
```
EXAMPLE 1
```{r, warning=FALSE}
books <- read.csv(file = "data/dataset_goodreads_filtered.csv", sep = ",", dec = ",")
select_user <- ratings_filtered["15559", ]

select_user_ids <- colnames(select_user)[!is.na(select_user)]
select_user_ids <- lapply(select_user_ids, as.numeric)
select_user_titles <- books[books$book_id %in% select_user_ids, c("title", "book_id", "image_url")]
select_user_ratings <- ratings[ratings$book_id %in% select_user_ids, c("rating", "book_id")]
select_user_ratings <- select_user_ratings[order(select_user_ratings$rating, decreasing = TRUE), ]

select_user_df <- left_join(select_user_ratings, select_user_titles, by = "book_id")
select_user_df <- select_user_df[!duplicated(select_user_df$book_id), ]

select_user_mat <- as.matrix(select_user)
select_user_mat <- as(select_user_mat, 'realRatingMatrix')

select_user_df |> filter(rating > 3) |>
  mutate(image = paste0('<img src="', image_url, '" style="max-width:100px; max-height:100px;"></img>')) |>
  arrange(-rating) |>
  top_n(20,wt = rating) |>
  dplyr::select(image, title, rating) |>
  datatable(class = "nowrap hover row-border", escape = FALSE, options = list(dom = 't',scrollX = TRUE, autoWidth = TRUE))
```

```{r}
predict_SVDF <- predict(book_reco_SVDF, 
                       select_user_mat,
                       type = "topNList",
                       n = 10
                       )

predict_SVDF
```
```{r}
predict_SVDF_list <- as(predict_SVDF, 'list')
predict_SVDF_list <- lapply(predict_SVDF_list, as.numeric)
predict_SVDF_df <- as.data.frame(predict_SVDF_list)
names(predict_SVDF_df) <- "book_id"
```
```{r}
recommendations_SVDF <- merge(predict_SVDF_df, books, by = "book_id")
#print(recommendations_SVDF$title)

recommendations_SVDF %>%
  mutate(image = paste0('<img src="', image_url, '" style="max-width:100px; max-height:100px;"></img>')) %>%
  select(image, title) %>%
  datatable(class = "nowrap hover row-border", escape = FALSE, options = list(dom = 't', scrollX = TRUE, autoWidth = TRUE))
```
```{r}
predict_ubcf <- predict(book_reco_UBCF, 
                       select_user_mat,
                       type = "topNList",
                       n = 10
                       )

predict_ubcf
```
```{r}
predict_ubcf_list <- as(predict_ubcf, 'list')
predict_ubcf_list <- lapply(predict_ubcf_list, as.numeric)
predict_ubcf_df <- as.data.frame(predict_ubcf_list)
names(predict_ubcf_df) <- "book_id"

recommendations_ubcf <- merge(predict_ubcf_df, books, by = "book_id")
#print(recommendations_ubcf$title)

recommendations_ubcf %>%
  mutate(image = paste0('<img src="', image_url, '" style="max-width:100px; max-height:100px;"></img>')) %>%
  select(image, title) %>%
  datatable(class = "nowrap hover row-border", escape = FALSE, options = list(dom = 't', scrollX = TRUE, autoWidth = TRUE))
```
```{r}
predict_ubcf_centered <- predict(book_reco_UBCF_centered, 
                       select_user_mat,
                       type = "topNList",
                       n = 10
                       )

predict_ubcf_centered
```
```{r}
predict_ubcf_centered_list <- as(predict_ubcf_centered, 'list')
predict_ubcf_centered_list <- lapply(predict_ubcf_centered_list, as.numeric)
predict_ubcf_centered_df <- as.data.frame(predict_ubcf_centered_list)
names(predict_ubcf_centered_df) <- "book_id"

recommendations_ubcf_centered <- merge(predict_ubcf_centered_df, books, by = "book_id")
#print(recommendations_ubcf_centered$title)

recommendations_ubcf_centered |>
  mutate(image = paste0('<img src="', image_url, '" style="max-width:100px; max-height:100px;"></img>')) %>%
  dplyr::select(image, title) |>
  datatable(class = "nowrap hover row-border", escape = FALSE, options = list(dom = 't',scrollX = TRUE, autoWidth = TRUE))
```
EXAMPLE 2
```{r, warning=FALSE}
books <- read.csv(file = "data/dataset_goodreads_filtered.csv", sep = ",", dec = ",")
select_user <- ratings_filtered[268, ]

select_user_ids <- colnames(select_user)[!is.na(select_user)]
select_user_ids <- lapply(select_user_ids, as.numeric)
select_user_titles <- books[books$book_id %in% select_user_ids, c("title", "book_id", "image_url")]
select_user_ratings <- ratings[ratings$book_id %in% select_user_ids, c("rating", "book_id")]
select_user_ratings <- select_user_ratings[order(select_user_ratings$rating, decreasing = TRUE), ]

select_user_df <- left_join(select_user_ratings, select_user_titles, by = "book_id")
select_user_df <- select_user_df[!duplicated(select_user_df$book_id), ]

select_user_mat <- as.matrix(select_user)
select_user_mat <- as(select_user_mat, 'realRatingMatrix')

select_user_df |> filter(rating > 3) |>
  mutate(image = paste0('<img src="', image_url, '" style="max-width:100px; max-height:100px;"></img>')) |>
  arrange(-rating) |>
  top_n(10,wt = rating) |>
  dplyr::select(image, title, rating) |>
  datatable(class = "nowrap hover row-border", escape = FALSE, options = list(dom = 't',scrollX = TRUE, autoWidth = TRUE))
```
```{r}
predict_SVDF <- predict(book_reco_SVDF, 
                       select_user_mat,
                       type = "topNList",
                       n = 10
                       )

predict_SVDF
```
```{r}
predict_SVDF_list <- as(predict_SVDF, 'list')
predict_SVDF_list <- lapply(predict_SVDF_list, as.numeric)
predict_SVDF_df <- as.data.frame(predict_SVDF_list)
names(predict_SVDF_df) <- "book_id"
```
```{r}
recommendations_SVDF <- merge(predict_SVDF_df, books, by = "book_id")
#print(recommendations_SVDF$title)

recommendations_SVDF %>%
  mutate(image = paste0('<img src="', image_url, '" style="max-width:100px; max-height:100px;"></img>')) %>%
  select(image, title) %>%
  datatable(class = "nowrap hover row-border", escape = FALSE, options = list(dom = 't', scrollX = TRUE, autoWidth = TRUE))
```
```{r}
predict_ubcf <- predict(book_reco_UBCF, 
                       select_user_mat,
                       type = "topNList",
                       n = 10
                       )

predict_ubcf
```
```{r}
predict_ubcf_list <- as(predict_ubcf, 'list')
predict_ubcf_list <- lapply(predict_ubcf_list, as.numeric)
predict_ubcf_df <- as.data.frame(predict_ubcf_list)
names(predict_ubcf_df) <- "book_id"

recommendations_ubcf <- merge(predict_ubcf_df, books, by = "book_id")
#print(recommendations_ubcf$title)

recommendations_ubcf %>%
  mutate(image = paste0('<img src="', image_url, '" style="max-width:100px; max-height:100px;"></img>')) %>%
  select(image, title) %>%
  datatable(class = "nowrap hover row-border", escape = FALSE, options = list(dom = 't', scrollX = TRUE, autoWidth = TRUE))
```
```{r}
predict_ubcf_centered <- predict(book_reco_UBCF_centered, 
                       select_user_mat,
                       type = "topNList",
                       n = 10
                       )

predict_ubcf_centered
```
```{r}
predict_ubcf_centered_list <- as(predict_ubcf_centered, 'list')
predict_ubcf_centered_list <- lapply(predict_ubcf_centered_list, as.numeric)
predict_ubcf_centered_df <- as.data.frame(predict_ubcf_centered_list)
names(predict_ubcf_centered_df) <- "book_id"

recommendations_ubcf_centered <- merge(predict_ubcf_centered_df, books, by = "book_id")
#print(recommendations_ubcf_centered$title)

recommendations_ubcf_centered |>
  mutate(image = paste0('<img src="', image_url, '" style="max-width:100px; max-height:100px;"></img>')) %>%
  dplyr::select(image, title) |>
  datatable(class = "nowrap hover row-border", escape = FALSE, options = list(dom = 't',scrollX = TRUE, autoWidth = TRUE))
```
